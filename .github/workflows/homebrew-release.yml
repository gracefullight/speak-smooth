name: publish-homebrew-cask

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: Tag to publish (e.g. v0.1.0)
        required: true
        type: string

permissions:
  contents: write

jobs:
  publish:
    runs-on: macos-14
    env:
      APP_NAME: SpeakSmooth
      CASK_NAME: speak-smooth
      TAP_REPO: ${{ vars.HOMEBREW_TAP_REPO }}
      TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
      TAG_NAME: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.event.release.tag_name }}
    steps:
      - name: Validate required configuration
        run: |
          set -euo pipefail
          if [ -z "${TAP_REPO}" ]; then
            echo "HOMEBREW_TAP_REPO repository variable is required"
            exit 1
          fi
          if [ -z "${TAP_TOKEN}" ]; then
            echo "HOMEBREW_TAP_GITHUB_TOKEN secret is required"
            exit 1
          fi
          if [ -z "${TAG_NAME}" ]; then
            echo "Tag name is required"
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Build release app bundle
        run: |
          set -euo pipefail
          xcodebuild -project SpeakSmooth.xcodeproj -scheme SpeakSmooth -configuration Release -derivedDataPath build build

      - name: Package app and compute checksum
        id: package
        run: |
          set -euo pipefail
          VERSION="${TAG_NAME#v}"
          APP_PATH="build/Build/Products/Release/${APP_NAME}.app"
          ASSET_NAME="${APP_NAME}-${VERSION}.zip"

          if [ ! -d "${APP_PATH}" ]; then
            echo "App bundle not found at ${APP_PATH}"
            exit 1
          fi

          ditto -c -k --sequesterRsrc --keepParent "${APP_PATH}" "${ASSET_NAME}"
          SHA256="$(shasum -a 256 "${ASSET_NAME}" | awk '{print $1}')"
          ASSET_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG_NAME}/${ASSET_NAME}"

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "asset_name=${ASSET_NAME}" >> "$GITHUB_OUTPUT"
          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"
          echo "asset_url=${ASSET_URL}" >> "$GITHUB_OUTPUT"

      - name: Upload release asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          gh release upload "${TAG_NAME}" "${{ steps.package.outputs.asset_name }}" --clobber

      - name: Checkout Homebrew tap
        uses: actions/checkout@v4
        with:
          repository: ${{ vars.HOMEBREW_TAP_REPO }}
          token: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
          path: tap

      - name: Update cask file
        run: |
          set -euo pipefail
          bash scripts/update-homebrew-cask.sh \
            tap \
            "${CASK_NAME}" \
            "${{ steps.package.outputs.version }}" \
            "${{ steps.package.outputs.sha256 }}" \
            "${{ steps.package.outputs.asset_url }}" \
            "${GITHUB_REPOSITORY}"

      - name: Commit and push cask update
        working-directory: tap
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "Casks/${CASK_NAME}.rb"
          if git diff --cached --quiet; then
            echo "No cask changes to commit"
            exit 0
          fi
          git commit -m "${CASK_NAME} ${{ steps.package.outputs.version }}"
          git push
