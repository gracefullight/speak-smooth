[env]
PROJECT = "SpeakSmooth.xcodeproj"
SCHEME = "SpeakSmooth"
DESTINATION = "platform=macOS"

[tasks.dev]
description = "Build and launch the app in Debug"
alias = "d"
run = '''
#!/usr/bin/env bash
set -euo pipefail
xcodebuild -project "$PROJECT" -scheme "$SCHEME" -configuration Debug build

APP_PATH="$(
  xcodebuild -project "$PROJECT" -scheme "$SCHEME" -configuration Debug -showBuildSettings \
  | awk -F' = ' '/TARGET_BUILD_DIR/{dir=$2} /FULL_PRODUCT_NAME/{name=$2} END{print dir "/" name}'
)"

if [ -z "${APP_PATH}" ] || [ ! -d "${APP_PATH}" ]; then
  echo "Could not find built app path."
  exit 1
fi

open "${APP_PATH}"
'''

[tasks.build]
description = "Build the app in Release"
alias = "b"
run = '''
#!/usr/bin/env bash
set -euo pipefail
xcodebuild -project "$PROJECT" -scheme "$SCHEME" -configuration Release build
'''

[tasks.test]
description = "Run unit tests"
alias = "t"
run = '''
#!/usr/bin/env bash
set -euo pipefail
xcodebuild test -project "$PROJECT" -scheme "$SCHEME" -destination "$DESTINATION"
'''

[tasks.lint]
description = "Run SwiftLint when available, else compile-check"
alias = "l"
run = '''
#!/usr/bin/env bash
set -euo pipefail
if command -v swiftlint >/dev/null 2>&1; then
  swiftlint
else
  xcodebuild -project "$PROJECT" -scheme "$SCHEME" -configuration Debug build -quiet
fi
'''
